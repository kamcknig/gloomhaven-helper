<div *ngIf="selectedToken"
     [ngStyle]="{ 'visibility': selectedToken ? 'visible': 'hidden' }"
     class="status-select-overlay">
  <button mat-mini-fab
          (click)="closeStatusSelectOverlay()"
          style="position: absolute; right: 5px; top: 5px;"><mat-icon>cancel</mat-icon></button>

  <div fxFlexFill
       fxLayout="row wrap"
       fxLayoutAlign="center center"
       fxLayoutGap=".7rem grid">
    <img *ngFor="let value of ApplicableConditions"
         [src]="'assets/icons/' + value.toLowerCase() + '.png'"
         [ngStyle]="{ 'filter': (selectedToken?.appliedConditionsAndEffects?.[value.toString()] ?? 0) > 0 ? 'brightness(100%)' : 'brightness(50%)' }"
         (click)="tokenService.toggleTokenStatus$.next({ token: selectedToken, condition: value})"
    >
  </div>
</div>

<mat-card>
  <mat-card-header>
    <mat-card-title>{{value?.name}}</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <div fxLayout="row" fxLayoutAlign="space-between center" class="text-m">
      <!-- normal stats -->
      <div fxLayout="row" style="align-items: flex-start"
           [ngStyle]="{ 'place-content': index === 0 ? 'flex-start' : 'flex-end' }" fxFlex
           *ngFor="let index of [0, 1]">
        <span fxLayout="column" fxLayoutAlign="start center">
          <img class="icon" src="assets/icons/health.png">
          {{getStatDisplayValue(value?.health?.[scenarioLevel ?? 0]?.[index])}}
        </span>

        <span fxLayout="column" fxLayoutAlign="start center">
          <img class="icon" src="assets/icons/move.png">
          {{getStatDisplayValue(value?.move?.[scenarioLevel ?? 0]?.[index])}}
        </span>

        <span fxLayout="column" fxLayoutAlign="start center">
          <img class="icon" src="assets/icons/attack.png">
          {{getStatDisplayValue(value?.attack?.[scenarioLevel ?? 0]?.[index])}}
        </span>

        <span fxLayout="column" fxLayoutAlign="start center">
          <img class="icon" src="assets/icons/range.png">
          {{getStatDisplayValue(value?.range?.[scenarioLevel ?? 0]?.[index])}}
        </span>
      </div>
    </div>

    <p-divider></p-divider>

    <div>Tokens</div>

    <div fxLayout="row"
         fxLayoutAlign="space-between">
      <p-scrollPanel fxFlex="50"
                     [style]="{ height: '6rem' }">
        <div fxLayout="column"
             fxLayoutAlign="start start">
          <ng-container *ngFor="let token of (tokens$ | async)?.normals"
                        [ngTemplateOutlet]="listItemTemplate"
                        [ngTemplateOutletContext]="{ '$implicit': token }">
          </ng-container>
        </div>
      </p-scrollPanel>

      <p-scrollPanel fxFlex="50"
                     [style]="{ height: '6rem' }">
        <div fxLayout="column"
             fxLayoutAlign="start start">
          <ng-container *ngFor="let token of (tokens$ | async)?.elites"
                        [ngTemplateOutlet]="listItemTemplate"
                        [ngTemplateOutletContext]="{ '$implicit': token }">
          </ng-container>
        </div>
      </p-scrollPanel>
    </div>
  </mat-card-content>

  <mat-card-footer>
    <button
      pButton
      type="button"
      (click)="addToken()"
      icon="pi pi-plus"></button>
  </mat-card-footer>
</mat-card>

<ng-template #listItemTemplate let-token>
  <div
    [id]="'list-item-' + (token.elite ? 'elite' : 'normal')"
    fxFlexFill
    fxLayout="row"
    fxLayoutAlign="space-between center"
    fxLayoutGap=".3rem"
    class="list-item">
    <div>{{token.number}} - <span class="text-red-600">{{token.health ?? token.maxHealth}}</span></div>

    <div fxFlex
         fxLayout="row wrap"
         fxLayoutAlign="center center"
         (click)="showStatusSelectOverlay(token)">
      <ng-container *ngIf="getTokenConditionsAndEffects(token).length > 0; else openApplicableConditions">
        <ng-container *ngFor="let value of getTokenConditionsAndEffects(token)">
          <img
            [src]="'assets/icons/' + value.name.toLowerCase() + '.png'"
            class="status-icon">
        </ng-container>
      </ng-container>

      <ng-template #openApplicableConditions>
        <span style="cursor: pointer" class="material-icons-outlined">more_horiz</span>
      </ng-template>
    </div>

    <div fxLayout="column"
         fxLayoutAlign="center end">
      <button (click)="tokenService.updateTokenHitPoint$.next([token, 1])"
              pButton
              pRipple
              type="button"
              style="background: unset; border: unset"
              icon="pi pi-plus"></button>

      <button (click)="tokenService.updateTokenHitPoint$.next([token, -1])"
              pButton
              pRipple
              type="button"
              style="background: unset; border: unset"
              icon="pi pi-minus"></button>
    </div>
  </div>
</ng-template>
